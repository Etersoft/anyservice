#!/bin/sh

PIDFile=$(pwd)/test.pid
User="guest"
WorkingDirectory=$(pwd)
ExecStart="./test_process"
LOGDIR=./
NEWSERVNAME="test"

#Install test suite: # wget http://shunit2.googlecode.com/files/shunit2-2.1.6.tgz && tar zxvf shunit2-2.1.6.tgz
shunit2=/home/danil/Projects/createPackage/shunit2/shunit2-2.1.6/src/shunit2

#/sbin/start-stop-daemon --start --exec /bin/su --pidfile $PIDFile --make-pidfile --user $User -- -s /bin/sh -l $User -c "cd $WorkingDirectory ; exec $ExecStart &" &> $LOGDIR/$NEWSERVNAME.log
#/sbin/start-stop-daemon --start --exec /bin/su --pidfile $PIDFile --make-pidfile -b --user $User -- -s /bin/sh -l $User -c "cd $WorkingDirectory ; exec $ExecStart &" &> $LOGDIR/$NEWSERVNAME.log

#TODO give start command arguments after -- #example: sleep -- 100
/sbin/start-stop-daemon --start --pidfile $PIDFile --background --make-pidfile --chuid $User --exec "$WorkingDirectory/$ExecStart" &> $LOGDIR/$NEWSERVNAME.log
#/sbin/start-stop-daemon --start --pidfile $PIDFile --make-pidfile --user $User --startas "$WorkingDirectory/$ExecStart" &> $LOGDIR/$NEWSERVNAME.log
echo "start-stop exit status $?" >> $LOGDIR/$NEWSERVNAME.log


testPid(){
    realpid=$(cat my.pid)
    #cat $PIDFile
    #echo $realpid
    sspid=$(cat $PIDFile)
    my_assert_equals "$sspid" "$realpid" "ss-pid $sspid $realpid"
}

testUser(){
    my_assert_equals "$User" $(cat my.user) User
}

testDir(){
    my_assert_equals "$WorkingDirectory" "$(cat my.dir)" "Dir"
}

testHome(){
    my_assert_equals "/home/$User" "$(cat my.home)" "Home dir"
}

my_assert_equals(){
    assertEquals "$3" "$1" "$2"
    #[ "$1" = "$2" ] && echo "Тест $3 прошёл" || echo "Тест $3 не прошёл"
}

test_bg(){
    #    echo "Test without background"
    /sbin/start-stop-daemon --start --pidfile $PIDFile --make-pidfile --user $User --exec "$WorkingDirectory/${ExecStart}_bg" &> $LOGDIR/$NEWSERVNAME.log
    testPid
}

. $shunit2 #include test suite
